name: Prerender and Deploy to Pages

on:
  push:
    branches:
      - main
  repository_dispatch:
    types: [cms-content-updated]
  workflow_dispatch:  # Permite trigger manual para testing

concurrency:
  group: prerender-deploy-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  prerender-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout frontend repo
        uses: actions/checkout@v4

      - name: ðŸ“¥ Checkout CMS scripts
        uses: actions/checkout@v4
        with:
          repository: dahemar/cms
          path: cms-scripts
          sparse-checkout: |
            scripts/prerender_for_actions.js
          sparse-checkout-cone-mode: false

      - name: âš™ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: ðŸŽ¨ Run prerender script
        env:
          CMS_API_URL: ${{ secrets.CMS_API_URL || 'https://cms-woad-delta.vercel.app' }}
          CMS_SITE_ID: ${{ secrets.CMS_SITE_ID || '3' }}
          CMS_SECTION_ID: ${{ secrets.CMS_SECTION_ID || '21' }}
          OUTPUT_DIR: '.'
          REPO_TYPE: 'cineclub'
          CMS_MEDIA_BASE_URL: ${{ secrets.CMS_MEDIA_BASE_URL || '' }}
        run: |
          echo "ðŸŽ¬ Starting prerender for cineclub..."
          echo "  CMS_API_URL: $CMS_API_URL"
          echo "  CMS_SITE_ID: $CMS_SITE_ID"
          echo "  CMS_SECTION_ID: $CMS_SECTION_ID"
          node cms-scripts/scripts/prerender_for_actions.js
          
          echo ""
          echo "ðŸ“„ Generated files:"
          ls -lh posts.html posts_bootstrap.json 2>/dev/null || echo "No files generated"
          
          echo ""
          echo "ðŸ“Š File sizes:"
          wc -l posts.html posts_bootstrap.json 2>/dev/null || true

      - name: ðŸ” Verify generated files
        run: |
          if [ ! -f "posts.html" ]; then
            echo "âŒ posts.html not found!"
            exit 1
          fi
          if [ ! -f "posts_bootstrap.json" ]; then
            echo "âŒ posts_bootstrap.json not found!"
            exit 1
          fi
          
          # Validar JSON
          if ! jq empty posts_bootstrap.json 2>/dev/null; then
            echo "âŒ posts_bootstrap.json is not valid JSON!"
            exit 1
          fi
          
          echo "âœ… All files validated"

      - name: âš™ï¸ Install Vercel CLI
        run: npm install -g vercel

      - name: ðŸš€ Deploy to Vercel
        id: vercel_deploy
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
        run: |
          echo "Deploying to Vercel (using VERCEL_TOKEN)"
          # Deploy repo root to Vercel
          vercel deploy --prod --token "$VERCEL_TOKEN" --yes

      - name: âœ… Deployment complete
        run: |
          echo "ðŸŽ‰ Vercel deployment triggered"
          echo "(Check Vercel dashboard for deployment status)"
          
      - name: ðŸ“‹ Summary
        if: always()
        run: |
          echo "## Prerender & Deploy Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Trigger**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **CMS Site**: ${{ secrets.CMS_SITE_ID || '3' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **CMS Section**: ${{ secrets.CMS_SECTION_ID || '21' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.deployment.outcome }}" == "success" ]; then
            echo "- **Deployed URL**: ${{ steps.deployment.outputs.page_url }}" >> $GITHUB_STEP_SUMMARY
          fi
